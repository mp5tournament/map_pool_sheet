<html>
<head>
    <link rel="icon" sizes="32x32" href="icon.png">
    <meta charset="utf-8">
    <title>å›¾æ± è¡¨ç”Ÿæˆå™¨</title>  
<style>
body{
    background-color:#F3F5F7;
    margin:0;
    font-size:18px;
    line-height: 30px;
    overflow-x: hidden;
}
.hidden{
    display: none;
}
#body{
    width:830px;
    padding:0 10px;
    margin: auto;
    background-color:white;
    min-height: 100vh;
}
h1{
    margin-top: 20px;
    margin-bottom: 0px;
    float: left;
}
#introduction{
    margin-top: 60px;
    line-height: 10px;
    font-size:10px;
    color:#808080;
    padding: 0;
    float: right;
}
#introduction a{
    display:inline !important;
    color:#808080 !important;
}
#introduction a:hover{
    background-color:white !important;
    color: #A0A0A0 !important;
}
td{
    font-size:18px;
    line-height: 30px;
    vertical-align:top;
}
.title{
    font-size:22px;
    font-weight:bold;
    width:100px;
}
.comment{
    font-size:14px;
    color: #55A;
    line-height: 24px;
}
.ltitle{
    width: 102px;
}
input{
    width:160px;
    font-size:18px;
    height:30px;
}
textarea{
    resize:none;
    width:150px;
    font-size:18px;
    height:222px;
    font-family: inherit;
}
button{
    font-size:18px;
    height:30px;
    border-radius: 5px;
}
#generate, #copy{
    width:224px;
}
#save_config, #delete_config{
    width:120px;
    margin-left:15px;
}
#delete_config{
    background-color:#FBC;
}
#delete_config:hover{
    background-color:#FCD;
}
#copy{
    background-color:#A1FFA1;
}
#copy:hover{
    background-color:#C4FFC4;
}
#generate, #save_config{
    background-color:#FD8;
}
#generate:hover, #save_config:hover{
    background-color:#FEA;
}
select{
    width:160px;
    font-size:18px;
    height:30px;
}
#content{
    font-size: 14px;
    line-height: 18px;
    min-height: 24px;
    max-width: 712px;
    box-shadow: inset 1px 1px 3px grey;
    padding:4px;
    background-color: white;
    white-space: break-spaces;
}
#content p{
    margin: 0;
}
i{
    padding-right:3.5px;
    padding-left:1px;
    margin:0 1px;
    background-color: #E8E8E8;
}
a{
    color: #66F;
}
a:hover{
    color: #99F;
}
textarea::placeholder,input::placeholder{
    color:#AAA;
}
</style>
</head>
<body>
<div style="width: 100vw;">
<div id="body">
<div style="height:75px">
    <h1>å›¾æ± è¡¨ç”Ÿæˆå™¨</h1>
    <div id="introduction">é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/mp5tournament/map_pool_sheet" target="_blank">https://github.com/mp5tournament/map_pool_sheet</a></div>
</div>
<hr style="margin-top:0">
<table style="width:100%">
    <tr>
        <td class="title">apikey</td>
        <td class="comment" colspan="2">è¯·<a href="https://osu.ppy.sh/home/account/edit#legacy-api" target="_blank">ç‚¹å‡»æ­¤å¤„</a>å¹¶ä¸‹æ»‘è‡³é¡µé¢åº•éƒ¨â€œLegacy APIâ€å¤„è·å–æ—§ç‰ˆapikeyï¼Œå®ƒåº”å½“æ˜¯ä¸€ä¸ªä»…åŒ…å«å°å†™å­—æ¯å’Œæ•°å­—çš„å­—ç¬¦ä¸²ã€‚</td>
    </tr>
    <tr>
        <td></td>
        <td style="width:570px"><input id="apikey" style="width:100%;" placeholder="abcdefghijklmnopqrstuvwxyz01234567890123"></td>
        <td><input id="remember" type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">è®°ä½apikey</td>
    </tr>
</table>
<hr>
<table style="width:100%">
    <tr>
        <td class="title">æ ¼å¼è®¾ç½®</td>
        <td><table><tr>
            <td class="ltitle">é¢„è®¾ï¼š</td>
            <td><select id="config_name"></select><input id="show_config" type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">è‡ªå®šä¹‰</td>
        </tr></table></td>
    </tr>
    <tr id="config" class="hidden">
        <td></td>
        <td>
            <hr><table><tr>
                <td class="ltitle">è®¾ç½®åï¼š</td>
                <td><input></td>
                <td><button id="save_config">ä¿å­˜è®¾ç½®</button></td>
                <td><button id="delete_config">åˆ é™¤è®¾ç½®</button></td>
                <td id="flash_config" style="padding-left:12px;opacity:0">ğŸ†—</td>
            </tr></table>
            <hr><table style="width: 100%;"><tr>
                <td class="ltitle">å›¾æ± æ ¼å¼ï¼š</td>
                <td><input placeholder="${link}{bid}${artist_unicode} - {title_unicode} [{version}] ({creator})${star}${cs} / {ar} / {od}${bpm}${ttl} ({max_combo}x)" style="width: 100%;"></td>
            </tr><tr><td class="comment" colspan="2">
                æ¯å¼ å›¾æ‰€å¯¹åº”ä¸€è¡Œä¸­çš„æ ¼å¼ï¼Œé¦–ä¸ªå­—ç¬¦ä¼šè¢«å½“åšä¸åŒå•å…ƒæ ¼ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œä¹‹åçš„åŒæ ·å­—ç¬¦å°†ä¼šè¢«è½¬åŒ–ä¸ºåˆ¶è¡¨ç¬¦ï¼Œä»¥è¾¾åˆ°èƒ½å¤Ÿç›´æ¥å‘è¡¨æ ¼å¤åˆ¶çš„æ•ˆæœã€‚<br>
                <i>{å­—æ®µå}</i>ä¼šè¢«æ›¿æ¢æˆç›¸åº”æ•°æ®ï¼Œæ¯”å¦‚<i>{star}</i>ä¼šè¢«æ›¿æ¢æˆå›¾çš„æ˜Ÿæ•°ã€‚å¦‚æœä½ å¸Œæœ›çœŸæ­£æ˜¾ç¤º<i>{</i>å’Œ<i>}</i>è¿™ä¸¤ä¸ªå­—ç¬¦ï¼Œè¯·ç”¨<i>{{</i>å’Œ<i>}}</i>ä»£æ›¿ã€‚<br>
                æ”¯æŒæ—§ç‰ˆapiä¸­get_beatmapsçš„å…¨éƒ¨å­—æ®µåï¼ˆå…·ä½“è¯·æŸ¥è¯¢<a href="https://github.com/ppy/osu-api/wiki#Beatmap" target="_blank">å®˜æ–¹æ–‡æ¡£</a>ï¼Œä½¿ç”¨å®˜æ–¹æ–‡æ¡£å­—æ®µæ—¶å°†ä¼šä¿ç•™apiæä¾›çš„åŸæ•°æ®ã€‚æ­¤å¤–<i>star</i>ã€<i>ar</i>ã€<i>od</i>ã€<i>cs</i>ã€<i>hp</i>ã€<i>ttl</i>ã€<i>htl</i>ã€<i>bid</i>ã€<i>sid</i>å‡ä¼šåˆ†åˆ«æŒ‡å‘ç›¸åº”å­—æ®µï¼Œä¸”<i>star</i>é»˜è®¤ä¿ç•™å¹¶æ˜¾ç¤ºä¸¤ä½å°æ•°ï¼Œå››ç»´é»˜è®¤ä¿ç•™å¹¶æ˜¾ç¤ºä¸€ä½å°æ•°ï¼Œ<i>ttl</i>å’Œ<i>htl</i>åˆ†åˆ«ä¸ºm:ssçš„æ ¼å¼çš„<i>total_length</i>å’Œ<i>hit_length</i>ã€‚<br>
                <i>{link}</i>å°†ä½¿ç›¸åº”å•å…ƒæ ¼å˜ä¸ºæŒ‡å‘å®˜ç½‘ç›¸åº”å›¾çš„é“¾æ¥ã€‚ä¾‹å¦‚ä¸€ä¸ªæ ¼å¼ä¸º<i>{link}ã€{bid}ã€‘</i>çš„å•å…ƒæ ¼ï¼Œå¯¹äºbidä¸º1000684çš„å›¾ï¼Œå°†ä¼šæ˜¾ç¤º<i>ã€1000684ã€‘</i>ï¼Œå¹¶æ˜¯ä¸€ä¸ªæŒ‡å‘<i>https://osu.ppy.sh/b/1000684</i>çš„é“¾æ¥ã€‚è¯¥é“¾æ¥åœ¨Excelã€qqè¡¨æ ¼ã€Googleè¡¨æ ¼ä¸­å‡ç”Ÿæ•ˆï¼Œä½†å•å…ƒæ ¼æ ¼å¼éœ€ä¸º<i>å¸¸è§„</i>ã€‚è¿™ç§å•å…ƒæ ¼ä¸­çš„åŠè§’è‹±æ–‡åŒå¼•å·<i>"</i>å°†è¢«å…¨è§’è‹±æ–‡åŒå¼•å·<i>ï¼‚</i>ä»£æ›¿ã€‚<br>
                å¯¹äºå°æ•°å­—æ®µï¼Œ<i>{å­—æ®µå.n}</i>å°†å¼ºåˆ¶ä¿ç•™å¹¶æ˜¾ç¤ºnä½å°æ•°ï¼Œè€Œ<i>{å­—æ®µå~n}</i>å°†å¼ºåˆ¶ä¿ç•™nä½å°æ•°ï¼Œä½†ä¸æ˜¾ç¤ºæœ«å°¾çš„0ã€‚ä¾‹å¦‚å¯¹äºä¸€å¼ arä¸º9.6667çš„å›¾ï¼Œ<i>{ar.2}</i>å’Œ<i>{ar~2}</i>éƒ½ä¼šæ˜¾ç¤ºä¸º<i>9.67</i>ï¼›å¯¹äºä¸€å¼ arä¸º9.1çš„å›¾ï¼Œ<i>{ar.2}</i>ä¼šæ˜¾ç¤ºä¸º<i>9.10</i>ï¼Œè€Œ<i>{ar~2}</i>ä¼šæ˜¾ç¤ºä¸º<i>9.1</i>ã€‚
            </td></tr><tr>
                <td></td>
            </tr></table>
            <hr><table><tr>
                <td class="ltitle">FMæ ¼å¼ï¼š</td>
                <td><input placeholder="{NM} / {HR}">
                    <input type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">æ˜Ÿæ•°
                    <input type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">AR
                    <input type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">OD
                    <input type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">CS
                    <input type="checkbox" style="margin-left:20px;margin-bottom:5px;height:20px;width:20px;vertical-align:bottom;">HP</td>
                <td></td>
            </tr><tr><td class="comment" colspan="2">åœ¨FMæ—¶ï¼Œå›¾çš„æ˜Ÿæ•°å’Œå››ç»´å¯èƒ½è·ŸéšMODå˜åŒ–ï¼Œå¦‚æœä½ å¸Œæœ›åœ¨å›¾æ± è¡¨ä¸­æ˜¾ç¤ºä¸åŒMODçš„æ˜Ÿæ•°æˆ–å››ç»´ï¼Œåˆ™å¯ä»¥å¯ç”¨ç›¸åº”é€‰é¡¹ã€‚<br>
            ä¾‹å¦‚FMæ ¼å¼ä¸º<i>{NM} / {HR}</i>æ—¶ï¼Œå¦‚æœé€‰ä¸­äº†<i>æ˜Ÿæ•°</i>é€‰é¡¹ï¼Œå¯¹äºä¸€å¼ åŸæœ¬ä¸º5.00æ˜Ÿï¼ŒHRåä¸º5.50æ˜Ÿçš„å›¾ï¼Œå¦‚æœå®ƒçš„MODä¸ºFMï¼Œå…¶å›¾æ± è¡¨ä¸­çš„<i>{star}</i>å°†ä¼šæ˜¾ç¤ºä¸º<i>5.00 / 5.50</i>ï¼›ä½†å¦‚æœå®ƒçš„MODä¸ºNMï¼Œåˆ™<i>{star}</i>ä¾ç„¶ä¼šæ˜¾ç¤ºæˆ<i>5.00</i>ï¼Œä¸ä¼šå—åˆ°æœ¬é¡¹è®¾ç½®çš„å½±å“ã€‚</td></tr><tr>
                <td></td>
            </tr></table>
            <hr><table style="width: 100%;"><tr>
                <td class="ltitle">MODè¯†åˆ«ï¼š</td>
                <td><textarea style="width: 100%;height: 78px;" placeholder="NM4 HD2 HR2 DT2
NM5 HD2 HR2 DT3 FM2 TB
NM6 HD3 HR3 DT4 FM2 TB"></textarea></td>
            </tr><tr><td class="comment" colspan="2">æœ¬é¡¹å¯ä»¥æ ¹æ®å›¾çš„æ€»æ•°è‡ªåŠ¨è¯†åˆ«æ¯å¼ å›¾çš„MODï¼Œæ¯è¡Œå¯¹åº”ä¸€ä¸ªå›¾çš„æ€»æ•°ã€‚ä»…æ”¯æŒä¸‹æ–¹MODåˆ—è¡¨é‡Œæœ‰çš„é¡¹ç›®ã€‚<br>
            ä¾‹å¦‚å½“ç¬¬ä¸€è¡Œä¸º<i>NM4 HD2 HR2 DT2</i>ï¼Œç¬¬äºŒè¡Œä¸º<i>NM5 HD2 HR2 DT3 FM2 TB</i>æ—¶ï¼Œå¦‚æœä¸€å…±å¡«å…¥äº†10å¼ å›¾ï¼Œåˆ™å›¾æ•°é‡å’Œç¬¬ä¸€è¡Œä¸€è‡´ï¼Œå‰4å¼ å›¾å°†è¢«è¯†åˆ«ä¸ºNMï¼Œæ¥ä¸‹æ¥2å¼ æ˜¯HDï¼Œä»¥æ­¤ç±»æ¨ï¼›å¦‚æœä¸€å…±å¡«å…¥äº†15å¼ å›¾ï¼Œåˆ™å›¾æ•°é‡å’Œç¬¬äºŒè¡Œä¸€è‡´ï¼Œä¼šæŒ‰ç…§ç¬¬äºŒè¡Œè¯†åˆ«ï¼›å¦‚æœä¸€å…±å¡«å…¥äº†14å¼ å›¾ï¼Œå›¾æ•°é‡å’Œä»»ä½•ä¸€è¡Œå‡ä¸ä¸€è‡´ï¼Œåˆ™æ‰€æœ‰å›¾å‡è¢«è¯†åˆ«ä¸ºNMã€‚</td></tr><tr>
                <td></td>
            </tr></table>
        </td>
    </tr>
</table>
<hr>
<table style="width:100%">
    <tr>
        <td class="title">å›¾æ± ä¿¡æ¯</td>
        <td class="comment" colspan="3">è¯·åœ¨æ­¤å¤„å¡«å†™å›¾æ± ä¿¡æ¯ï¼Œæ¯è¡Œå¡«å†™ä¸€å¼ å›¾çš„BIDï¼Œå¹¶åœ¨å³ä¾§é€‰æ‹©ç›¸åº”çš„MODã€‚å›¾çš„æ˜Ÿæ•°ã€é•¿åº¦ã€å››ç»´ç­‰å‡ä¼šæ ¹æ®MODè½¬åŒ–ï¼Œå¦‚æœä¸å¸Œæœ›å…¶è½¬åŒ–ï¼Œé€‰æ‹©NMç­‰MODå³å¯ã€‚è‹¥ä¸ºè‡ªåŠ¨è¯†åˆ«ï¼Œåˆ™å°†æ ¹æ®ä¸Šä¸€é¡¹çš„è®¾ç½®æ¥è¯†åˆ«ï¼Œæ— æ³•è¯†åˆ«æ—¶ä¼šå…¨éƒ½å½“åšNM/HD/TBç­‰ä¸éœ€è¦ä¿®æ”¹å›¾æ± æ•°æ®çš„MODã€‚</td>
    </tr>
    <tr style="height: 36px;">
        <td rowspan="3"></td>
        <td rowspan="3" style="width: 200px;"><textarea id="pool" placeholder="1000684
327526"></textarea></td>
        <td style="width:234px">MODï¼š<select id="mod"><option value="">â­è‡ªåŠ¨è¯†åˆ«</option><option value="NM">âšªNM/HD/TBâ€¦</option><option value="HR">ğŸ”´HR</option><option value="DT">ğŸŸ£DT</option><option value="FM">ğŸ”µFM</option><option value="EZ">ğŸŸ¢EZ</option><option value="FL">âš«FL</option><option value="HT">ğŸŸ¤HT</option></select></td>
    </tr>
    <tr style="height: 36px;">
        <td><button id="generate">ç”Ÿæˆå›¾æ± ä¿¡æ¯</button></td>
        <td id="flash_generate" style="opacity:0">ğŸ†—</td>
    </tr>
    <tr>
        <td><button id="copy">å¤åˆ¶å›¾æ± ä¿¡æ¯</button></td>
        <td id="flash_copy" style="opacity:0">ğŸ†—</td>
    </tr>
</table>
<hr>
<table style="width:100%">
    <tr>
        <td class="title">ç”Ÿæˆå†…å®¹</td>
        <td><div id="content" disabled></div></td>
    </tr>
    <tr>
        <td></td>
        <td></td>
    </tr>
</table>
</div></div>
<script type="text/javascript">
const _mod=`
NM5 HD2 HR2 DT3 FM2 TB
NM6 HD3 HR3 DT3 FM2 TB
NM6 HD3 HR3 DT4 FM3 TB
`.trim()

const isInteger=/^-?[0-9]+$/
const isIntegerP=/^[0-9]+$/
const modList={
    NM:0,
    HD:0,
    HR:16,
    DT:64,
    FM:0,
    TB:0,
    EZ:2,
    FL:1024,
    HT:256
}
const fieldList={
    beatmapset_id: 1,
    beatmap_id: 1,
    approved: 1,
    total_length: 1,
    hit_length: 1,
    version: 1,
    file_md5: 1,
    diff_size: 0,
    diff_overall: 0,
    diff_approach: 0,
    diff_drain: 0,
    mode: 1,
    count_normal: 1,
    count_slider: 1,
    count_spinner: 1,
    submit_date: 1,
    approved_date: 1,
    last_update: 1,
    artist: 1,
    artist_unicode: 1,
    title: 1,
    title_unicode: 1,
    creator: 1,
    creator_id: 1,
    bpm: 0,
    source: 1,
    tags: 1,
    genre_id: 1,
    language_id: 1,
    favourite_count: 1,
    rating: 0,
    storyboard: 1,
    video: 1,
    download_unavailable: 1,
    audio_unavailable: 1,
    playcount: 1,
    passcount: 1,
    packs: 1,
    max_combo: 1,
    diff_aim: 0,
    diff_speed: 0,
    difficultyrating: 0,

    star: 0,
    ar: 0,
    od: 0,
    cs: 0,
    hp: 0,
    ttl: 1,
    htl: 1,
    bid: 1,
    sid: 1,
}
const altName={
    star: ['difficultyrating','.',2],
    ar: ['diff_approach','.',1],
    od: ['diff_overall','.',1],
    cs: ['diff_size','.',1],
    hp: ['diff_drain','.',1],
    ttl: ['total_length',':',0],
    htl: ['hit_length',':',0],
    bid: ['beatmap_id',null,0],
    sid: ['beatmapset_id',null,0],
}

function formatNumber(x,t,d){
    if(t==':'){
        x=parseInt(x)
        let y=x%60
        let z=(x-y)/60
        let y0=y<10?'0':''
        return `${z}:${y0}${y}`
    }
    x=Number(x)
    let n=x<0?1:0
    if(n)x=-x
    for(let i=0;i<d;i++)x*=10
    x=String(Math.round(x))
    if(x=='0')n=false
    while(x.length<=d){
        x='0'+x
    }
    let x1=d?x.slice(0,-d):x
    let x2=d?x.slice(-d):''
    if(t=='~'){
        let i=x2.length-1
        for(;i>=0;i--)if(x2[i]!='0')break
        x2=x2.slice(0,i+1)
    }
    return (n?'-':'')+x1+(x2?('.'+x2):'')
}

const apikey=document.getElementById('apikey')
const remember=document.getElementById('remember')
const pool=document.getElementById('pool')
const configName=document.getElementById('config_name')
const config=document.getElementById('config')
const configInput=config.getElementsByTagName('input')
const content=document.getElementById('content')

let configDataDefault={
    'MP5é€‰å›¾è¡¨':{
        format:'${artist_unicode} - {title_unicode} [{version}] ({creator})${star}${ttl}${ar}${bpm.0}${link}{bid}',
        fm:'{NM} / {HR}',
        fmList:[true,false,false,false,false],
        mod:_mod,
    },
    'MP5é€‰å›¾è¡¨(æ— bid)':{
        format:'${artist_unicode} - {title_unicode} [{version}] ({creator})${star}${ttl}${ar}${bpm.0}',
        fm:'{NM} / {HR}',
        fmList:[true,false,false,false,false],
        mod:_mod,
    },
    'MP5ä¸»è¡¨æ ¼':{
        format:'${link}{bid}${artist_unicode} - {title_unicode} [{version}] ({creator})${star}${cs} / {ar} / {od}${bpm.0}${ttl} ({max_combo}x)',
        fm:'{NM} / {HR}',
        fmList:[true,false,false,false,false],
        mod:_mod,
    },
    'æ ‡é¢˜ç½—é©¬éŸ³':{
        format:'${title}',
        fm:'{NM} / {HR}',
        fmList:[true,false,false,false,false],
        mod:_mod,
    },
}
let configData={}
let result=''

// å±•ç¤º

function flash(id){
    let box=document.getElementById('flash_'+id)
    {
        box.style.opacity = 0.25
        setTimeout(function(){
            box.style.opacity = 0.5
        },40)
        setTimeout(function(){
            box.style.opacity = 0.75
        },80)
        setTimeout(function(){
            box.style.opacity = 1
        },120)
    }
    setTimeout(function(){
        box.style.opacity = 0.75
        setTimeout(function(){
            box.style.opacity = 0.5
        },40)
        setTimeout(function(){
            box.style.opacity = 0.25
        },80)
        setTimeout(function(){
            box.style.opacity = 0
        },120)
    },500)
}


// è¯»é…ç½®

function changeConfig(){
    if(configName.value)try{
        configActive=configData[configName.value]
        if(configActive){
            configInput[0].value=configName.value
            configInput[1].value=configActive.format
            configInput[2].value=configActive.fm
            configInput[3].checked=configActive.fmList[0]
            configInput[4].checked=configActive.fmList[1]
            configInput[5].checked=configActive.fmList[2]
            configInput[6].checked=configActive.fmList[3]
            configInput[7].checked=configActive.fmList[4]
            config.getElementsByTagName('textarea')[0].value=configActive.mod
        }
    }catch{}
    
}

function initConfig(){
    configData={...configDataDefault}
    try{
        config_data=JSON.parse(localStorage.getItem('map_pool_sheet'))['config_data']
        for(let c in config_data)if(!(c in configData))configData[c]=config_data[c]
    }catch{}
    configName.innerHTML='<option value="" class="hidden">è‡ªå®šä¹‰â€¦</option>'
    for(let c in configData)configName.options.add(new Option(c,c))

    let config_name=null
    try{
        config_name=JSON.parse(localStorage.getItem('map_pool_sheet'))['config_name']
    }catch{}
    if(!(config_name in configData))config_name='MP5é€‰å›¾è¡¨'
    configName.value=config_name
}

function custom(){
    configName.value=''
}
for(let input of config.getElementsByTagName('input'))input.onchange=custom
config.getElementsByTagName('textarea')[0].onchange=custom
configName.onchange=changeConfig
initConfig()
changeConfig()

// å†™é…ç½®

document.getElementById('save_config').onclick=function(){
    config_data={}
    try{
        config_data=JSON.parse(localStorage.getItem('map_pool_sheet'))['config_data']
    }catch{}
    let config_name=configInput[0].value.trim()
    if(!config_name){
        alert('è®¾ç½®åä¸èƒ½ä¸ºç©ºã€‚')
        return
    }
    if(config_name=='MP5é€‰å›¾è¡¨'){
        alert('è®¾ç½®åä¸èƒ½ä¸ºâ€œMP5é€‰å›¾è¡¨â€ã€‚')
        return
    }
    if(config_name=='MP5ä¸»è¡¨æ ¼'){
        alert('è®¾ç½®åä¸èƒ½ä¸ºâ€œMP5ä¸»è¡¨æ ¼â€ã€‚')
        return
    }
    config_data[config_name]={
        format:configInput[1].value,
        fm:configInput[2].value,
        fmList:[configInput[3].checked,configInput[4].checked,configInput[5].checked,configInput[6].checked,configInput[7].checked],
        mod:config.getElementsByTagName('textarea')[0].value.trim(),
    }
    localStorage.setItem('map_pool_sheet',JSON.stringify({config_data,config_name}))
    flash('config')
    initConfig()
}
document.getElementById('delete_config').onclick=function(){
    let name=configInput[0].value.trim()
    if(!name){
        alert('è®¾ç½®åä¸èƒ½ä¸ºç©ºã€‚')
        return
    }
    if(name=='MP5é€‰å›¾è¡¨'){
        alert('ä¸èƒ½åˆ é™¤â€œMP5é€‰å›¾è¡¨â€ã€‚')
        return
    }
    if(name=='MP5ä¸»è¡¨æ ¼'){
        alert('ä¸èƒ½åˆ é™¤â€œMP5ä¸»è¡¨æ ¼â€ã€‚')
        return
    }
    config_data={}
    try{
        config_data=JSON.parse(localStorage.getItem('map_pool_sheet'))['config_data']
        config_name=JSON.parse(localStorage.getItem('map_pool_sheet'))['config_name']
    }catch{}
    if(!(name in config_data)){
        alert('æ²¡æœ‰è¿™ä¸ªè®¾ç½®åã€‚')
        return
    }
    delete config_data[name]
    localStorage.setItem('map_pool_sheet',JSON.stringify({config_data,config_name}))
    flash('config')
    initConfig()
}

// apikey

if(localStorage.getItem('apikey')) apikey.value=localStorage.getItem('apikey')
if(localStorage.getItem('remember')) remember.checked=true

function saveApikey(){
    if(remember.checked){
        localStorage.setItem('remember',1)
        localStorage.setItem('apikey',apikey.value.trim())
    }else{
        localStorage.removeItem('remember')
        localStorage.removeItem('apikey')
    }
}
remember.onchange=saveApikey
apikey.onchange=saveApikey

document.getElementById('show_config').onchange=function(){
    if(document.getElementById('show_config').checked){
        config.classList.remove('hidden')
        configName.value=''
    }else{
        config.classList.add('hidden')
    }
}

// è¯»æ ¼å¼

function getConvert(fmNeed){
    let row=configInput[1].value.substring(1).split(configInput[1].value[0])
    for(let i in row){
        let n=0
        let m=0
        row[i]=row[i].replaceAll('{{',function(){
            n++
            return '{_0}'
        })
        row[i]=row[i].replaceAll('}}',function(){
            m++
            return '{_1}'
        })
        for(let item of row[i].match(/{[^\{\}]+}/g)){
            let name=item.slice(1,-1).split(/[.~]/g)
            name[0]=name[0].trim().toLowerCase()
            if(name[0]=='_0'){
                n--
                continue
            }
            if(name[0]=='_1'){
                m--
                continue
            }
            if(name[0]=='link')continue
            if(!(name[0] in fieldList)) throw `å›¾æ± æ ¼å¼è®¾ç½®ä¸­â€œ${item}â€å­—æ®µé”™è¯¯ï¼Œæ²¡æœ‰è¿™ä¸ªå­—æ®µã€‚`
            if(name.length>2){
                throw `å›¾æ± æ ¼å¼è®¾ç½®ä¸­â€œ${item}â€å­—æ®µæ ¼å¼é”™è¯¯ã€‚`
            }
            if(name.length==2){
                if(!(isIntegerP.test(name[1].trim()))) throw `å›¾æ± æ ¼å¼è®¾ç½®ä¸­â€œ${item}â€å­—æ®µæ ¼å¼é”™è¯¯ã€‚`
                if(fieldList[name[0]]) throw `å›¾æ± æ ¼å¼è®¾ç½®ä¸­â€œ${item}â€å­—æ®µæ ¼å¼é”™è¯¯ï¼Œè¯¥å­—æ®µä¸æ”¯æŒå°æ•°åŠŸèƒ½ã€‚`
            }
        }
        if(n)throw `å›¾æ± æ ¼å¼è®¾ç½®ä¸­â€œ{_0}â€å­—æ®µé”™è¯¯ï¼Œæ²¡æœ‰è¿™ä¸ªå­—æ®µã€‚`
        if(m)throw `å›¾æ± æ ¼å¼è®¾ç½®ä¸­â€œ{_1}â€å­—æ®µé”™è¯¯ï¼Œæ²¡æœ‰è¿™ä¸ªå­—æ®µã€‚`
    }

    let fmFormat=configInput[2].value
    let convertList={}
    let convertFM=null
    if(fmFormat){
        let n=0
        let m=0
        fmFormat=fmFormat.replaceAll('{{',function(){
            n++
            return '{_0}'
        })
        fmFormat=fmFormat.replaceAll('}}',function(){
            m++
            return '{_1}'
        })
        for(let item of fmFormat.match(/{[^\{\}]+}/g)){
            let mod=item.slice(1,-1).trim().toUpperCase()
            if(mod=='_0'){
                n--
                continue
            }
            if(mod=='_1'){
                m--
                continue
            }
            if(!(mod in modList)) throw `FMæ ¼å¼è®¾ç½®ä¸­â€œ${item}â€MODé”™è¯¯ï¼Œæ²¡æœ‰è¿™ä¸ªMODã€‚`
            fmNeed[mod]=1
        }
        if(n)throw `FMæ ¼å¼è®¾ç½®ä¸­â€œ{_0}â€MODé”™è¯¯ï¼Œæ²¡æœ‰è¿™ä¸ªMODã€‚`
        if(m)throw `FMæ ¼å¼è®¾ç½®ä¸­â€œ{_1}â€MODé”™è¯¯ï¼Œæ²¡æœ‰è¿™ä¸ªMODã€‚`

        if(configInput[3].checked)convertList['difficultyrating']=1
        if(configInput[4].checked)convertList['diff_approach']=1
        if(configInput[5].checked)convertList['diff_overall']=1
        if(configInput[6].checked)convertList['diff_size']=1
        if(configInput[7].checked)convertList['diff_drain']=1
        convertFM=function(map,name,type,digit){
            return fmFormat.replaceAll(/{[^\{\}]+}/g,function(item){
                let mod=item.slice(1,-1).trim().toUpperCase()
                if(mod=='_0')return'{'
                if(mod=='_1')return'}'
                let x=map[mod][name]
                if(type)x=formatNumber(x,type,digit)
                return x
            })
        }
    }
    
    function convert(map){
        if(map.Unavailable)return ''
        let result=[]
        for(let d of row){
            let link=false
            d=d.replaceAll(/{[^\{\}]+}/g,function(item){
                let type=item.match(/[.~]/g)
                type=type?type[0]:null
                let name=item.slice(1,-1).split(/[.~]/g)
                let digit=type?parseInt(name[1]):0
                name=name[0].trim().toLowerCase()
                if(name=='_0')return'{'
                if(name=='_1')return'}'
                if(name=='link'){
                    link=true
                    return ''
                }

                let alt=altName[name]
                if(alt){
                    name=alt[0]
                    if(!type){
                        type=alt[1]
                        digit=alt[2]
                    }
                }
                let x=''
                let mod=map.mod
                if(map.mod=='FM'){
                    if(name in convertList){
                        x=convertFM(map,name,type,digit)
                        mod=null
                    }
                    else mod='NM'
                }
                if(mod) {
                    x=map[mod][name]
                    if(!x){
                        if(name=='artist_unicode')x=map[mod]['artist']
                        if(name=='title_unicode')x=map[mod]['title']
                    }
                    if(type)x=formatNumber(x,type,digit)
                }
                return x
            })
            result.push(link?`=HYPERLINK("https://osu.ppy.sh/b/${map.bid}","${d.replaceAll('"','ï¼‚')}")`:d)
        }
        return result.join('\t')
    }
    
    return convert
}

function arByMod(x,mod){
    if(mod=='DT'){
        if(x<=5) return 5+8*x/15
        return (13+2*x)/3
    }else{
        if(x<=5) return (4*x-15)/3
        if(x<=7) return (5*x-20)/3
        return (4*x-13)/3
    }
}

function convertModData(map,mod){
    let data=map[mod]
    switch(mod){
        case 'EZ':
        case 'HR':
            for(let name of ['diff_approach','diff_overall','diff_size','diff_drain']){
                let x=Number(data[name])
                if(mod=='EZ')x/=2
                else{
                    if(name=='diff_size') x=x>7.692?10:x*1.3
                    else x=x>7.142?10:x*1.4
                }
                data[name]=x
            }
            break
        case 'DT':
        case 'HT':
            for(let name of ['total_length','hit_length']){
                let x=Number(data[name])
                data[name]=mod=='DT'?x/1.5:x/0.75
            }{
                let x=Number(data['bpm'])
                data['bpm']=mod=='DT'?x*1.5:x*0.75
            }{
                let x=Number(data['diff_approach'])
                data['diff_approach']=arByMod(x,mod)
            }{
                let x=Number(data['diff_overall'])
                data['diff_overall']=mod=='DT'? (6*x+40)/9 : (12*x-40)/9
            }
    }
}

// ç”Ÿæˆ

function getMap(map,mod,status,retry=2){
    let xhr = new XMLHttpRequest()
    xhr.open('get', `https://osu.ppy.sh/api/get_beatmaps?k=${apikey.value.trim()}&b=${map.bid}&m=0&mods=${modList[mod]}`)
    xhr.send()
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            try{
                if(!xhr.responseText)throw 'blank'
                if(xhr.responseText=='[]'){
                    map.Unavailable=true
                    status.last-=1
                    status.noMap=map.bid
                    return
                }
                let ans=JSON.parse(xhr.responseText)
                if(ans.error){
                    status.apikey=true
                    return
                }
                if(ans[0]){
                    map[mod]=ans[0]
                    convertModData(map,mod)
                    status.last-=1
                    return
                }
            }catch{}
            if(retry)setTimeout(function(){getMap(map,mod,status,retry-1)}, 2000)
            else status.connection=true
        }
    }
}

function checkGenerate(Maps,convert,status){
    if(status.connection){
        alert('æœªèƒ½è¿æ¥osuï¼Œè¯·ç¡®ä¿æ‚¨æä¾›çš„apikeyæœ‰æ•ˆï¼Œå¹¶æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚')
        document.getElementById('generate').removeAttribute('disabled')
        return
    }
    if(status.apikey){
        alert('æ‚¨æä¾›çš„apikeyæ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•ã€‚')
        document.getElementById('generate').removeAttribute('disabled')
        return
    }
    if(status.noMap){
        alert(`æ²¡æœ‰åœ¨osuä¸­æŸ¥æ‰¾åˆ°æ‚¨æä¾›çš„bidâ€œ${status.noMap}â€æ‰€å¯¹åº”çš„å›¾ï¼Œç›¸åº”è¡Œå°†ç•™ç©ºï¼Œä½†æŸ¥è¯¢ä»å°†ç»§ç»­ã€‚`)
    }
    if(status.last){
        setTimeout(function(){checkGenerate(Maps,convert,status)},500)
        return
    }

    let ans=[]
    for(let map of Maps)ans.push(convert(map))

    result=ans.join('\n')
    content.textContent=result
    document.getElementById('generate').removeAttribute('disabled')
    flash('generate')
}

document.getElementById('generate').onclick=function(){
    if(!apikey.value.trim()){
        alert('è¯·å¡«å†™apikeyã€‚')
        return
    }

    let fmNeed={NM:1}
    let convert=null
    try{
        convert=getConvert(fmNeed)
    }catch(e){
        alert(e)
        return
    }

    let Maps=[]
    for(let bid of pool.value.trim().split('\n')){
        bid=bid.trim()
        if(!bid)continue
        if(!isInteger.test(bid)){
            alert(`æ— æ³•è¯†åˆ«å›¾æ± ä¸­çš„â€œ${bid}â€`)
            return
        }
        Maps.push({bid})
    }

    let modByI=null
    if(document.getElementById('mod').value){
        const mod=document.getElementById('mod').value
        modByI=function(i){return mod}
    }else{
        let modIdentify={}
        for(let line of config.getElementsByTagName('textarea')[0].value.trim().split('\n')){
            let s=0
            let d=[]
            for(let modn of line.split(' ')){
                modn=modn.trim()
                if(!modn)continue
                let mod=modn.substring(0,2).toUpperCase() 
                let n=modn.substring(2)
                if(!n){
                    n=1
                }
                if(!(mod in modList) || !isIntegerP.test(n)){
                    alert(`MODè¯†åˆ«è®¾ç½®ä¸­â€œ${modn}â€æ ¼å¼é”™è¯¯ã€‚`)
                    return
                }
                n=parseInt(n)
                if(!n){
                    alert(`MODè¯†åˆ«è®¾ç½®ä¸­â€œ${modn}â€æ ¼å¼é”™è¯¯ã€‚`)
                    return
                }
                s+=n
                for(;n>0;n--)d.push(mod)
            }
            if(s in modIdentify){
                    alert(`MODè¯†åˆ«è®¾ç½®ä¸­å­˜åœ¨æ€»å›¾æ•°ç›¸ç­‰çš„ä¸¤è¡Œã€‚`)
                    return
            }else modIdentify[s]=d
        }

        if(Maps.length in modIdentify){
            modIdentify=modIdentify[Maps.length]
            modByI=function(i){return modIdentify[i]}
        }
        else modByI=function(i){return 'NM'}
    }

    document.getElementById('generate').setAttribute('disabled','')

    let status={last:0}
    for(let i in Maps){
        Maps[i].mod=modByI(i)
        if(Maps[i].mod=='FM')for(let mod in fmNeed)
            setTimeout(function(){getMap(Maps[i],mod,status)},(status.last++)*100)
        else
            setTimeout(function(){getMap(Maps[i],Maps[i].mod,status)},(status.last++)*100)
    }
    checkGenerate(Maps,convert,status)
}

const copyTextarea = document.createElement('textarea')
document.getElementById('copy').onclick=function(){
    document.body.appendChild(copyTextarea)
    copyTextarea.innerHTML = result
    copyTextarea.select()
    document.execCommand('Copy')
    document.body.removeChild(copyTextarea)
    flash('copy')
}

if(window.location.search){
    const modSelect=document.getElementById('mod')
    for(arg of window.location.search.substring(1).split('&')){
        if(arg.split('=')[0]=='mod'){
            let mod=arg.split('=')[1].toUpperCase()
            if(mod=='HD'||mod=='TB'){
                mod='NM'
            }
            modSelect.value=mod
        }
    }
}
</script>
</body>
</html>
